<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>전등배치 원클릭 앱 (KS A 3011 + CAD 자동처리 + AutoLISP)</title>
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <header>
      <h1>전등배치 원클릭 앱</h1>
      <p>
        KS A 3011 조도 기준 + 자동 수량 계산 + 실별 일괄 계산 + CAD 자동 처리(DXF/DWG 업로드)
        + AutoLISP(qqq/qqqall) 코드 생성
      </p>
    </header>

    <main>
      <section class="card">
        <h2>① 공통 설정</h2>
        <div class="grid two">
          <label>
            층고 (mm)
            <input id="floorHeight" type="number" value="2700" min="1000" step="10" />
          </label>

          <label>
            등기구 광속 (Lm)
            <input id="lumens" type="number" value="4400" min="100" step="10" />
          </label>

          <label>
            보수율 (MF)
            <input id="maintenanceFactor" type="number" value="0.9" min="0.1" max="1" step="0.01" />
          </label>

          <label>
            회로 번호 (쉼표 구분)
            <input id="circuits" type="text" value="45, 46" />
          </label>

          <label>
            KS 조도등급
            <select id="ksClass"></select>
          </label>

          <label>
            조도 기준 선택
            <select id="ksLevel">
              <option value="min">최저</option>
              <option value="std" selected>표준</option>
              <option value="max">최고</option>
            </select>
          </label>

          <label>
            목표 조도 (Lx, 수동 입력 가능)
            <input id="targetLux" type="number" value="400" min="1" step="1" />
          </label>

          <label>
            문자 스타일 (LISP 생성용)
            <input id="fontStyle" type="text" value="Standard" />
          </label>

          <label>
            이용률 계산 방식
            <select id="uMode">
              <option value="step">표준(계단식)</option>
              <option value="interp" selected>보간(부드럽게)</option>
            </select>
          </label>
        </div>
        <div class="actions">
          <button id="applyKsBtn">KS 값 자동 반영</button>
          <button id="resetBtn" class="ghost">기본값 복원</button>
        </div>
        <div class="preset-bar">
          <span>빠른 프리셋</span>
          <button type="button" class="ghost preset-btn" data-preset="office">사무실 기본</button>
          <button type="button" class="ghost preset-btn" data-preset="corridor">복도 기본</button>
          <button type="button" class="ghost preset-btn" data-preset="storage">창고 기본</button>
        </div>
      </section>

      <section class="card">
        <h2>② 단일 실 계산</h2>
        <div class="grid three">
          <label>
            실 가로 (mm)
            <input id="roomWidth" type="number" value="9000" min="100" step="10" />
          </label>
          <label>
            실 세로 (mm)
            <input id="roomHeight" type="number" value="6000" min="100" step="10" />
          </label>
          <label>
            실 면적 (㎡, 비우면 가로×세로 자동)
            <input id="roomArea" type="number" placeholder="자동 계산" min="0" step="0.01" />
          </label>
        </div>
        <div class="actions">
          <button id="calcSingleBtn">단일 실 계산</button>
        </div>
        <pre id="singleOutput" class="output"></pre>
        <div class="preview-wrap">
          <canvas id="singlePreview" width="640" height="320" aria-label="단일 실 조명 배치 미리보기"></canvas>
        </div>
        <p class="hint">※ 미리보기는 개념도이며, 실제 CAD 자동배치 결과와 일부 다를 수 있습니다.</p>
      </section>

      <section class="card">
        <h2>③ 다실(전체 배치도) 일괄 계산</h2>
        <p class="hint">
          한 줄에 한 실씩 입력하세요. 형식:
          <code>실명,가로mm,세로mm,면적㎡(선택),조도Lx(선택)</code>
        </p>
        <textarea id="bulkInput" rows="9" spellcheck="false">회의실A,9000,6000,,400
사무실1,12000,8000,,400
복도,20000,2500,,200</textarea>
        <div class="actions">
          <button id="calcBulkBtn">일괄 계산</button>
          <button id="downloadCsvBtn" class="ghost">결과 CSV 다운로드</button>
        </div>
        <div class="table-wrap">
          <table id="bulkTable">
            <thead>
              <tr>
                <th>실명</th>
                <th>면적(㎡)</th>
                <th>RI</th>
                <th>U</th>
                <th>조도(Lx)</th>
                <th>추천 수량(개)</th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr>
                <th colspan="5" data-label="항목">총 추천 수량</th>
                <th id="bulkTotal" data-label="값">0</th>
              </tr>
            </tfoot>
          </table>
        </div>
      </section>

      <section class="card">
        <h2>④ AutoLISP 생성 (QQQ + QQQALL)</h2>
        <p class="hint">
          현재 입력값으로 기본값이 채워진 LISP를 생성합니다. AutoCAD에서
          <code>APPLOAD</code>로 불러와 <code>QQQ</code>(단일),
          <code>QQQALL</code>(다중 경계 일괄) 명령으로 실행하세요.
          (이용률 계산 방식: 공통 설정의 선택값 반영)
        </p>
        <div class="actions">
          <button id="genLispBtn">LISP 생성</button>
          <button id="downloadLispBtn" class="ghost">qqq_auto.lsp 다운로드</button>
        </div>
        <textarea id="lispOutput" rows="16" spellcheck="false"></textarea>
      </section>

      <section class="card">
        <h2>⑤ CAD 자동 처리 (DXF/DWG → 방 인식 → 계산 → 결과 DXF)</h2>
        <p class="hint">
          도면을 업로드하면 닫힌 폴리라인을 방으로 자동 인식하고, 조도 계산 후 배치 점을 생성해
          결과 DXF를 내려받을 수 있습니다.
        </p>

        <div class="grid two">
          <label>
            CAD 파일 업로드 (.dxf, .dwg)
            <input id="cadFile" type="file" accept=".dxf,.dwg" />
          </label>

          <label>
            도면 단위
            <select id="cadUnit">
              <option value="mm" selected>mm</option>
              <option value="cm">cm</option>
              <option value="m">m</option>
            </select>
          </label>

          <label>
            최소 방 면적 (㎡)
            <input id="cadMinArea" type="number" value="3" min="0" step="0.1" />
          </label>

          <label>
            최대 방 면적 (㎡)
            <input id="cadMaxArea" type="number" value="5000" min="1" step="1" />
          </label>

          <label>
            배치 그리드 (mm)
            <input id="cadGrid" type="number" value="300" min="10" step="10" />
          </label>

          <label>
            출력 레이어명
            <input id="cadOutputLayer" type="text" value="LIGHT_AUTO" />
          </label>

          <label>
            심볼 반지름 (mm)
            <input id="cadSymbolRadius" type="number" value="150" min="1" step="1" />
          </label>

          <label>
            텍스트 오프셋 (mm)
            <input id="cadTextOffset" type="number" value="300" min="0" step="10" />
          </label>
        </div>

        <div class="actions">
          <button id="cadAnalyzeBtn">방 자동 인식</button>
          <button id="cadLayoutBtn">자동 배치 계산</button>
          <button id="cadExportBtn" class="ghost">결과 DXF 다운로드</button>
        </div>

        <pre id="cadStatus" class="output"></pre>

        <div class="table-wrap">
          <table id="cadRoomTable">
            <thead>
              <tr>
                <th>방</th>
                <th>레이어</th>
                <th>면적(㎡)</th>
                <th>RI</th>
                <th>U</th>
                <th>추천 수량</th>
                <th>배치 수량</th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr>
                <th colspan="5" data-label="항목">총합</th>
                <th id="cadRecommendedTotal" data-label="추천">0</th>
                <th id="cadPlacedTotal" data-label="배치">0</th>
              </tr>
            </tfoot>
          </table>
        </div>
      </section>

      <section class="card">
        <h2>⑥ KS A 3011 조도 등급표 (요약)</h2>
        <ul id="ksSummary"></ul>
        <p class="disclaimer">
          참고: 본 앱의 KS 값은 제공해주신 표(조도 등급 A~K) 기반 요약값입니다.
          실무 적용 시 프로젝트 발주처/최신 개정판/설계 기준서와 함께 최종 검토하세요.
        </p>
      </section>
    </main>

    <footer>
      <p>Built for one-click lighting layout workflow.</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@mlightcad/libdxfrw-web@0.1.0/dist/libdxfrw.js"></script>
    <script src="./app.js"></script>
  </body>
</html>
